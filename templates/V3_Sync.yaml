# EPICS V3 LaunchPad (bzr) to GitHub (git) sync Jenkins Jobs
#
# Jenkins Job Builder configuration template
#
# Author: Ralph Lange <ralph.lange@gmx.de>
# Copyright (C) 2015 ITER Organization.
# All rights reserved. Use is subject to license terms.

- job-template:
    name: 'V3-sync-{branch}-lp2gh'

    gh-repo: 'epics-base-x'
    email-notify: ralph.lange@gmx.de, mdavidsaver@gmail.com

    project-type: freestyle
    description: |
        <h2>Sync EPICS Base ({branch} series) from LaunchPad to GitHub.</h2>
        <p><i>Automatically generated job. <b>Do not edit using the web interface.</b><br>
        See <a href="https://github.com/epics-base/jenkins-jobs">job generator repository</a>
        for details.</i></p>
        <p>Imports EPICS {branch} from its LaunchPad bzr repository, converting it to git
        using <a href="https://github.com/felipec/git-remote-bzr">git-remote-bzr</a>, then
        pushes to the appropriate branch of {gh-repo} on GitHub.</p>

    properties:
        - github:
            url: https://github.com/epics-base/{gh-repo}/

    logrotate:
        daysToKeep: 60
        numToKeep: -1
        artifactDaysToKeep: 0
        artifactNumToKeep: 0

    scm:
        - raw:
            xml: |
                <scm class="hudson.plugins.bazaar.BazaarSCM" plugin="bazaar@1.22">
                <source>lp:epics-base/{branch}</source>
                <cleantree>false</cleantree>
                <checkout>true</checkout>
                </scm>

    triggers:
        - pollscm: "H/5 * * * *"

    builders:
        - shell: |
            export STUFF=/tmp/stuff
            rm -fr $STUFF
            mkdir -p $STUFF
            cd $STUFF
            wget -nv https://raw.githubusercontent.com/felipec/git-remote-bzr/master/git-remote-bzr
            wget -nv https://raw.githubusercontent.com/epics-base/hgxgit/master/1bzr2git.sh
            chmod +x git-remote-bzr 1bzr2git.sh
            export PATH=$PATH:$STUFF
            cd $WORKSPACE
            1bzr2git.sh {branch} {gh-repo}

- project:
    name: V3-sync
    branch:
        - 3.14
        - 3.15
        - 3.16
    jobs:
        - 'V3-sync-{branch}-lp2gh'
